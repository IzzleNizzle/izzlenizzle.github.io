name: Build Blog Posts

on:
  push:
    branches:
      - main
    paths:
      - 'blog/entries/*.md'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for git log to work correctly
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: |
          npm install -g markdown-it
          sudo apt-get update && sudo apt-get install -y jq
        
      - name: Convert Markdown to HTML
        run: |
          # Create output directory if it doesn't exist
          mkdir -p blog/posts
          
          # Create an index file for blog posts
          echo '[' > blog/posts/list.json
          
          first=true
          
          # Process each markdown file
          for md_file in blog/entries/*.md; do
            if [ -f "$md_file" ]; then
              # Get filename without extension
              filename=$(basename "$md_file" .md)
              
              # Skip README files
              if [ "$filename" = "README" ]; then
                continue
              fi
              
              # Extract date and title from filename
              # Expected format: YYYY-MM-DD -- title-with-hyphens.md (with space-dash-dash-space separator)
              # Also support: YYYY-MM-DD-title-with-hyphens.md (single dash separator)
              if [[ "$filename" =~ ^([0-9]{4}-[0-9]{2}-[0-9]{2})\ --\ (.+)$ ]]; then
                # Extract date from filename (YYYY-MM-DD format) - space-dash-dash-space format
                date="${BASH_REMATCH[1]}"
                # Extract title part (everything after the date and separator)
                title_part="${BASH_REMATCH[2]}"
                # Convert hyphens to spaces and capitalize words
                title=$(echo "$title_part" | sed 's/-/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) tolower(substr($i,2));}1')
              elif [[ "$filename" =~ ^([0-9]{4}-[0-9]{2}-[0-9]{2})-(.+)$ ]]; then
                # Extract date from filename (YYYY-MM-DD format) - single dash format
                date="${BASH_REMATCH[1]}"
                # Extract title part (everything after the date and first hyphen)
                title_part="${BASH_REMATCH[2]}"
                # Convert hyphens to spaces and capitalize words
                title=$(echo "$title_part" | sed 's/-/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) tolower(substr($i,2));}1')
              else
                # Fallback: no date in filename, use git commit date and filename as title
                date=$(git log -1 --format="%Y-%m-%d" -- "$md_file" 2>/dev/null || echo "1970-01-01")
                # Convert hyphens/underscores to spaces and capitalize
                title=$(echo "$filename" | sed 's/[-_]/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) tolower(substr($i,2));}1')
              fi
              
              # Convert markdown to HTML
              markdown-it "$md_file" > "blog/posts/${filename}.html.tmp"
              
              # Create full HTML page with template
              cat > "blog/posts/${filename}.html" << 'HTMLTEMPLATE'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>TITLE_PLACEHOLDER - IzzleNizzle Blog</title>
              <link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet'>
              <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
              <link href="../css/materialize.css" type="text/css" rel="stylesheet" media="screen,projection" />
              <style>
                  body {
                      font-family: "Roboto", sans-serif;
                      margin: 0;
                      background: #0d1117;
                      color: #c9d1d9;
                      line-height: 1.6;
                  }
                  .container {
                      max-width: 800px;
                      margin: 0 auto;
                      padding: 20px;
                  }
                  .header {
                      border-bottom: 1px solid #30363d;
                      padding-bottom: 20px;
                      margin-bottom: 30px;
                  }
                  .header h1 {
                      color: #58a6ff;
                      margin: 0 0 10px 0;
                  }
                  .back-link {
                      display: inline-block;
                      margin-bottom: 20px;
                      color: #58a6ff;
                      text-decoration: none;
                  }
                  .back-link:hover {
                      text-decoration: underline;
                  }
                  .content {
                      background: #161b22;
                      padding: 30px;
                      border-radius: 6px;
                      border: 1px solid #30363d;
                  }
                  .content h2 {
                      color: #58a6ff;
                      border-bottom: 1px solid #30363d;
                      padding-bottom: 10px;
                  }
                  .content h3 {
                      color: #58a6ff;
                  }
                  .content a {
                      color: #58a6ff;
                      text-decoration: none;
                  }
                  .content a:hover {
                      text-decoration: underline;
                  }
                  .content code {
                      background: #0d1117;
                      padding: 2px 6px;
                      border-radius: 3px;
                      font-family: monospace;
                  }
                  .content pre {
                      background: #0d1117;
                      padding: 16px;
                      border-radius: 6px;
                      overflow-x: auto;
                  }
                  .content pre code {
                      padding: 0;
                  }
                  .date {
                      color: #8b949e;
                      font-size: 0.9em;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <a href="../index.html" class="back-link">‚Üê Back to Blog</a>
                  <div class="header">
                      <h1>TITLE_PLACEHOLDER</h1>
                      <div class="date">DATE_PLACEHOLDER</div>
                  </div>
                  <div class="content">
          HTMLTEMPLATE

              # Append the converted HTML content
              cat "blog/posts/${filename}.html.tmp" >> "blog/posts/${filename}.html"
              
              # Close HTML template
              cat >> "blog/posts/${filename}.html" << 'HTMLEND'
                  </div>
              </div>
          </body>
          </html>
          HTMLEND

              # Replace placeholders - escape special characters in title for sed
              title_escaped=$(echo "$title" | sed 's/[&/\]/\\&/g')
              sed -i "s|TITLE_PLACEHOLDER|${title_escaped}|g" "blog/posts/${filename}.html"
              sed -i "s|DATE_PLACEHOLDER|${date}|g" "blog/posts/${filename}.html"
              
              # Clean up temp file
              rm "blog/posts/${filename}.html.tmp"
              
              # Add to JSON list (for blog index) - escape for JSON
              title_json=$(echo "$title" | sed 's/"/\\"/g')
              
              if [ "$first" = true ]; then
                first=false
              else
                echo ',' >> blog/posts/list.json
              fi
              
              echo "{\"title\":\"${title_json}\",\"filename\":\"${filename}\",\"date\":\"${date}\"}" >> blog/posts/list.json
            fi
          done
          
          echo ']' >> blog/posts/list.json
          
      - name: Pre-render blog index page
        run: |
          # Read the list.json and pre-render the blog posts in index.html
          # This eliminates the need for client-side JavaScript to load posts
          
          # Use jq and a while loop to properly handle the JSON
          blog_posts_html=""
          
          # Process each post from the sorted JSON array
          while IFS= read -r post; do
            title=$(echo "$post" | jq -r '.title')
            filename=$(echo "$post" | jq -r '.filename')
            date=$(echo "$post" | jq -r '.date')
            
            # Escape HTML special characters
            title_escaped=$(echo "$title" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g; s/'\''/\&#39;/g')
            filename_escaped=$(echo "$filename" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g; s/'\''/\&#39;/g')
            
            # Format the date
            formatted_date=$(date -d "$date" '+%B %-d, %Y' 2>/dev/null || date -j -f "%Y-%m-%d" "$date" '+%B %-d, %Y' 2>/dev/null || echo "$date")
            
            # Append article HTML
            blog_posts_html+="            <article>
                <header><a href=\"./posts/${filename_escaped}.html\">${title_escaped}</a></header>
                <small>${formatted_date}</small>
            </article>
"
          done < <(jq -c 'sort_by(.date) | reverse | .[]' blog/posts/list.json)
          
          # Update the blog/index.html with pre-rendered posts
          # Replace the loading message and script section with pre-rendered HTML
          awk -v posts="$blog_posts_html" '
            BEGIN { in_section=0; in_script=0; }
            /<section class="my_main_section">/ { 
              print; 
              print posts;
              in_section=1;
              next;
            }
            /<\/section>/ && in_section {
              print;
              in_section=0;
              next;
            }
            /<script>/ {
              in_script=1;
              next;
            }
            /<\/script>/ && in_script {
              in_script=0;
              next;
            }
            !in_section && !in_script { print; }
          ' blog/index.html > blog/index.html.tmp
          
          mv blog/index.html.tmp blog/index.html
          
      - name: Commit and push if changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add blog/posts/ blog/index.html
          if ! git diff --staged --quiet; then
            git commit -m "Auto-generate blog posts from markdown"
            git push origin HEAD:${GITHUB_REF#refs/heads/}
          else
            echo "No changes to commit"
          fi
