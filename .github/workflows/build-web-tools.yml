name: Build Web Tools Page

on:
  push:
    branches:
      - main
    paths:
      - 'web-tools/tools.json'
      - 'web-tools/templates/tools-template.html'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y jq
        
      - name: Pre-render web tools page
        run: |
          # Read the tools.json and pre-render the tools in index.html
          tools_html=""
          
          # Process each tool from the JSON array
          while IFS= read -r tool; do
            title=$(echo "$tool" | jq -r '.title')
            description=$(echo "$tool" | jq -r '.description')
            url=$(echo "$tool" | jq -r '.url')
            openInPopup=$(echo "$tool" | jq -r '.openInPopup')
            popupWidth=$(echo "$tool" | jq -r '.popupWidth // "400"')
            popupHeight=$(echo "$tool" | jq -r '.popupHeight // "800"')
            
            # Escape HTML special characters
            title_escaped=$(echo "$title" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g; s/'\''/\&#39;/g')
            description_escaped=$(echo "$description" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g; s/'\''/\&#39;/g')
            url_escaped=$(echo "$url" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g; s/'\''/\&#39;/g')
            
            # Build tags HTML
            tags_html=""
            tags=$(echo "$tool" | jq -r '.tags[]?' 2>/dev/null)
            if [ -n "$tags" ]; then
              while IFS= read -r tag; do
                if [ -n "$tag" ]; then
                  tag_escaped=$(echo "$tag" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g; s/'\''/\&#39;/g')
                  tags_html+="<span class=\"tool-tag\">${tag_escaped}</span>"
                fi
              done <<< "$tags"
            fi
            
            # Build onclick handler
            if [ "$openInPopup" = "true" ]; then
              onclick="onclick=\"window.open('${url_escaped}', '$(echo $title | tr ' ' '_')Popout', 'height=${popupHeight}px,width=${popupWidth}px,scrollbars=no,menubar=no,location=no,titlebar=no,status=no,toolbar=no,top=500,left=500'); return false;\""
            else
              onclick=""
            fi
            
            # Append tool card HTML
            tools_html+="        <article class=\"tool-card\" ${onclick}>
          <span class=\"tool-link-icon\">â†’</span>
          <h3 class=\"tool-title\">${title_escaped}</h3>
          <p class=\"tool-description\">${description_escaped}</p>
          <div class=\"tool-tags\">${tags_html}</div>
        </article>
"
          done < <(jq -c '.[]' web-tools/tools.json)
          
          # Replace the TOOLS_PLACEHOLDER with pre-rendered HTML
          # Using awk to handle multi-line replacement
          awk -v tools="$tools_html" '
            /TOOLS_PLACEHOLDER/ {
              printf "%s", tools;
              next;
            }
            { print; }
          ' web-tools/templates/tools-template.html > web-tools/index.html
          
      - name: Commit and push if changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add web-tools/index.html
          if ! git diff --staged --quiet; then
            git commit -m "Auto-generate web tools page from JSON"
            git push origin HEAD:${GITHUB_REF#refs/heads/}
          else
            echo "No changes to commit"
          fi
